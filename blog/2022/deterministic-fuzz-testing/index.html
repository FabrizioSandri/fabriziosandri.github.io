<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="adA2euCk5kykbeBzBFe7a-qGnkIiaI7x3jJgqrfEEIo"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Deterministic fuzz testing with DeepState and Rcpp | Fabrizio Sandri </title> <meta name="author" content="Fabrizio Sandri"> <meta name="description" content="Make DeepState fuzz testing with Rcpp, deterministic. Solution implemented in the pull request \#6"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico?77b41fb878aeb1e52dc168c0807c497e"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://fabriziosandri.github.io/blog/2022/deterministic-fuzz-testing/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Fabrizio</span> Sandri </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Deterministic fuzz testing with DeepState and Rcpp</h1> <p class="post-meta"> Created on June 21, 2022 </p> <p class="post-tags"> <a href="/blog/2022"> <i class="fa-solid fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/google-summer-of-code"> <i class="fa-solid fa-hashtag fa-sm"></i> Google Summer of Code</a>   <a href="/blog/tag/deepstate"> <i class="fa-solid fa-hashtag fa-sm"></i> DeepState</a>   <a href="/blog/tag/rcpp"> <i class="fa-solid fa-hashtag fa-sm"></i> Rcpp</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="motivation">Motivation</h2> <p>While searching for a way to perform non deterministic fuzz testing (using some kind of seeds) to be used in the workflow for the <a href="https://github.com/FabrizioSandri/RcppDeepState/pull/6" rel="external nofollow noopener" target="_blank">pull request #6</a>, I discovered that the seed would not work if the RInside declaration is made inside the <code class="language-plaintext highlighter-rouge">TEST</code> macro of the test Harness. Let’s have a look at an example.</p> <h2 id="example">Example</h2> <p>Recall to the example of the previous post, where we wanted to perform fuzz testing on a simple Rcpp function that takes an integer vector as input and returns the first element. Let’s say we want to discover a seed that will allow us to replicate the DeepState inputs throughout several executions, in a way that the execution will be deterministic. Let’s add a <code class="language-plaintext highlighter-rouge">cout</code> at line 36 in order to observe the inputs generated by DeepState.</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Rcpp.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;RInside.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;deepstate/DeepState.hpp&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">deepstate</span><span class="p">;</span>

<span class="c1">// [[Rcpp::export]]</span>
<span class="kt">int</span> <span class="nf">getFirstElement</span><span class="p">(</span><span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// random IntegerVector generation procedure</span>
<span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="nf">randomIntegerVector</span><span class="p">(</span><span class="kt">int</span> <span class="n">maxSize</span><span class="p">){</span>

    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">DeepState_IntInRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">maxSize</span><span class="p">);</span>
    <span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="n">vec</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeepState_IntInRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span>
  
    <span class="k">return</span> <span class="n">vec</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">TEST</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="n">name</span><span class="p">){</span>
    <span class="k">static</span> <span class="n">RInside</span> <span class="n">R</span><span class="p">;</span>
    
    <span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="n">randomVec</span> <span class="o">=</span> <span class="n">randomIntegerVector</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">randomVec</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">getFirstElement</span><span class="p">(</span><span class="n">randomVec</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>The result will change across several executions regardless of whether this harness is executed using the <code class="language-plaintext highlighter-rouge">--seed=1</code> argument. The first ten lines of output from two distinct runs are shown below, and it appears that the seed option has no influence on the produced input.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./getFirstElement <span class="nt">--fuzz</span> <span class="nt">--timeout</span><span class="o">=</span>1 <span class="nt">--seed</span><span class="o">=</span>1 | <span class="nb">head
</span>INFO: Starting fuzzing
WARNING: No <span class="nb">test </span>specified, defaulting to first <span class="nb">test </span>defined <span class="o">(</span>Unit_name<span class="o">)</span>
808 622 869 877 455 672 774 844
240 910 915 474 182 907 28 1000 921 295
168 356 675
825 344 511 36 735 784 573 715 622 338 351 542
750 202 746 817 227 9 588 973 14 4 194 627 987 249 578 315 275
415 918 1 777 966 69 806 69 559 978 421 300
867 214 429 872 755 856 345 993 722
942 378 593 210 780 393 760 430 106 400 846 144
767 669 263 278 872 625
265 58 203 89 832 969 144 952 266 192 975 327 386 816 946 35

<span class="nv">$ </span>./getFirstElement <span class="nt">--fuzz</span> <span class="nt">--timeout</span><span class="o">=</span>1 <span class="nt">--seed</span><span class="o">=</span>1 | <span class="nb">head
</span>INFO: Starting fuzzing
WARNING: No <span class="nb">test </span>specified, defaulting to first <span class="nb">test </span>defined <span class="o">(</span>Unit_name<span class="o">)</span>
657 470 974 648 599 658 812 515 388 162 698 87 20 672 429
355 22 104 1000 742 779 948 157 630 840 336 616 666 220 185 76 965 220 18
531 484 232 85
76 959 388 473 630 390 997 619 474 386 449 650 255 520 717 909 775 783 249 75
988 668
422
595
767 182 417 60 691 783 972 996 740 220 732 19 390 253 704 89 329 815
520 122 600 111 27 796 541 591 778 352 673 205 195 526 73
318 380 155 221 972 540 668 985 462 953 175
</code></pre></div></div> <h2 id="solution">Solution</h2> <p>This peculiar behavior, I discovered, is caused by the RInside statement within the <code class="language-plaintext highlighter-rouge">TEST</code> macro. The seed will work if the above program is modified by shifting the RInside declaration to the beginning and deleting the <code class="language-plaintext highlighter-rouge">static</code> keyword.</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Rcpp.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;RInside.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;deepstate/DeepState.hpp&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">deepstate</span><span class="p">;</span>

<span class="n">RInside</span> <span class="n">Rinstance</span><span class="p">;</span>

<span class="c1">// [[Rcpp::export]]</span>
<span class="kt">int</span> <span class="nf">getFirstElement</span><span class="p">(</span><span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// random IntegerVector generation procedure</span>
<span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="nf">randomIntegerVector</span><span class="p">(</span><span class="kt">int</span> <span class="n">maxSize</span><span class="p">){</span>

    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">DeepState_IntInRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">maxSize</span><span class="p">);</span>
    <span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="n">vec</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeepState_IntInRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span>
  
    <span class="k">return</span> <span class="n">vec</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">TEST</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="n">name</span><span class="p">){</span>
    
    <span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="n">randomVec</span> <span class="o">=</span> <span class="n">randomIntegerVector</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">randomVec</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">getFirstElement</span><span class="p">(</span><span class="n">randomVec</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>The output will now remain the same over multiple executions</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./getFirstElement <span class="nt">--fuzz</span> <span class="nt">--timeout</span><span class="o">=</span>1 <span class="nt">--seed</span><span class="o">=</span>1 | <span class="nb">head
</span>INFO: Starting fuzzing
WARNING: No <span class="nb">test </span>specified, defaulting to first <span class="nb">test </span>defined <span class="o">(</span>Unit_name<span class="o">)</span>
45 876 469 501 681 966 606 500 505 917 974 278
278 134
30 89 629 63 662 549 902 171 509 314 370 622 287 508
904 960 320 971 431 402 436 155
610 425 643 826 670 136 877 558 789 66 681 315 4
29 888 577 658 499 191 348 959 539 740 712 152 704 460 449 727
889 811 54 456 168 891 196 561 467 544 254 942 911 256 663 578 517 845
159 167 671 342 887 546 605 607 354 881 361 545 865 588 312
649 123
750 729 474 863 43 482

<span class="nv">$ </span>./getFirstElement <span class="nt">--fuzz</span> <span class="nt">--timeout</span><span class="o">=</span>1 <span class="nt">--seed</span><span class="o">=</span>1 | <span class="nb">head
</span>INFO: Starting fuzzing
WARNING: No <span class="nb">test </span>specified, defaulting to first <span class="nb">test </span>defined <span class="o">(</span>Unit_name<span class="o">)</span>
45 876 469 501 681 966 606 500 505 917 974 278
278 134
30 89 629 63 662 549 902 171 509 314 370 622 287 508
904 960 320 971 431 402 436 155
610 425 643 826 670 136 877 558 789 66 681 315 4
29 888 577 658 499 191 348 959 539 740 712 152 704 460 449 727
889 811 54 456 168 891 196 561 467 544 254 942 911 256 663 578 517 845
159 167 671 342 887 546 605 607 354 881 361 545 865 588 312
649 123
750 729 474 863 43 482
</code></pre></div></div> <p>This problem is resolved in the <a href="https://github.com/FabrizioSandri/RcppDeepState/pull/6" rel="external nofollow noopener" target="_blank">pull request #6</a>.</p> </div> </article> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2025 Fabrizio Sandri. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-0HTGSMCLSW"></script> <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'G-0HTGSMCLSW');
  </script> <script defer src="/assets/js/google-analytics-setup.js?12374742c4b1801ba82226e617af7e2d"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>