<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="adA2euCk5kykbeBzBFe7a-qGnkIiaI7x3jJgqrfEEIo"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Introduction to RcppDeepState | Fabrizio Sandri </title> <meta name="author" content="Fabrizio Sandri"> <meta name="description" content="An introduction to Rcpp fuzz testing using RcppDeepState auxiliary functions"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico?77b41fb878aeb1e52dc168c0807c497e"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://fabriziosandri.github.io/blog/2022/rcppdeepstate-introduction/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Fabrizio</span> Sandri </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Introduction to RcppDeepState</h1> <p class="post-meta"> Created on May 31, 2022 </p> <p class="post-tags"> <a href="/blog/2022"> <i class="fa-solid fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/google-summer-of-code"> <i class="fa-solid fa-hashtag fa-sm"></i> Google Summer of Code</a>   <a href="/blog/tag/rcppdeepstate"> <i class="fa-solid fa-hashtag fa-sm"></i> RcppDeepState</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="introduction-to-rcppdeepstate">Introduction to RcppDeepState</h1> <p>In previous posts, we’ve shown how to use DeepState in conjunction with Valgrind to create a tool that can detect more subtle programming errors in the code. In this post, we’ll introduce RcppDeepState, which will add another brick to this toolkit.</p> <h2 id="rcpp">Rcpp</h2> <p>The Rcpp package<sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup> gives R developers a way to write C++ code for some of its modules. It’s sometimes useful to write C++ code in place of R functions; it’s a performance trade-off. It has been demonstrated that R is particularly inefficient in computing recursive functions when compared to C++.</p> <p>It’s not the purpose of this article to discuss the Rcpp library, however what you need to know in order to continue is that Rcpp allows to call some external C++ functions exported to the R environment by tagging them with the <code class="language-plaintext highlighter-rouge">// [[Rcpp::export]]</code> comment on top of them.</p> <h3 id="installation">Installation</h3> <p>The installation of the library is quite a straightforward task since the package is available on CRAN.</p> <div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">install.packages</span><span class="p">(</span><span class="s2">"Rcpp"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div> <h3 id="sample-usage">Sample usage</h3> <p>Let’s look at a simple example of a Fibonacci recursive function written in C++ and exported to the R environment to have a better idea of how Rcpp works. Let’s start with a C++ definition of the Fibonacci function.</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>The first step to integrate this function with the R environment is to include the appropriate header of Rcpp with it’s associated namespace. The final step is to export the <code class="language-plaintext highlighter-rouge">fibonacci</code> function. As mentioned earlier to do this we use the <code class="language-plaintext highlighter-rouge">// [[Rcpp::export]]</code> comment. By doing this way, the R environment can easily understand which function should be exported. The final result should look somewhat like this:</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Rcpp.h&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">Rcpp</span><span class="p">;</span>

<span class="c1">// [[Rcpp::export]]</span>
<span class="kt">int</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>We don’t need to compile anything in order for this function to work; all we have to do in our R environment is include the appropriate library and call the <code class="language-plaintext highlighter-rouge">sourcCpp</code> function. This function automatically compiles the C++ code and sources it into the running environment, in the same way the standard <code class="language-plaintext highlighter-rouge">source</code> function works.</p> <div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="s2">"Rcpp"</span><span class="p">)</span><span class="w">
</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sourceCpp</span><span class="p">(</span><span class="s2">"./fibonacci.cpp"</span><span class="p">)</span><span class="w">
</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fibonacci</span><span class="p">(</span><span class="m">5</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">8</span><span class="w">
</span></code></pre></div></div> <h3 id="rcpp-based-package">Rcpp based package</h3> <p>In the previous example we ran a single C++ file, however most of the times Rcpp is bundled inside packages. This allows users to use this packages without actually having any C++ development tool. To initialize a package using Rcpp, we use the <code class="language-plaintext highlighter-rouge">Rcpp.package.skeleton</code> function. If you want to generate a package based on the previous Rcpp fibonacci script, simply supply a list of C++ files to the skeleton function’s <code class="language-plaintext highlighter-rouge">cpp_files</code> parameter.</p> <div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Rcpp.package.skeleton</span><span class="p">(</span><span class="s2">"Fibonacci"</span><span class="p">,</span><span class="w"> </span><span class="n">example_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">cpp_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"fibonacci.cpp"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div> <p>This way we end up with a folder containing a working Rcpp based module:</p> <ul> <li>Rcpp source file are located in <code class="language-plaintext highlighter-rouge">src</code> </li> <li>R files are located in <code class="language-plaintext highlighter-rouge">R</code> </li> <li>Rd documentation files are located in <code class="language-plaintext highlighter-rouge">man</code> </li> </ul> <h2 id="rcppdeepstate">RcppDeepState</h2> <p>Let’s get started with the main topic of this article: RcppDeepState. RcppDeepState is a combination of three different tools: Rcpp, DeepState, and Valgrind. RcppDeepState’s purpose is to perform fuzz testing on Rcpp-based modules. The related work is restricted to R-level fuzzing and does not include fuzz testing of compiled C++ code developed with Rcpp. The lack of such support for fuzz testing led Akhila Chowdary <sup id="fnref:2"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup> to create such a powerful tool.</p> <h3 id="installation-process">Installation process</h3> <p>Since RcppDeepState is not available on CRAN, it must be installed manually. We can use the traditional devtools way to download the package from the official repository and install it:</p> <div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">install.packages</span><span class="p">(</span><span class="s2">"devtools"</span><span class="p">)</span><span class="w">
</span><span class="n">require</span><span class="p">(</span><span class="s2">"devtools"</span><span class="p">)</span><span class="w">
</span><span class="n">devtools</span><span class="o">::</span><span class="n">install_github</span><span class="p">(</span><span class="s2">"akhikolla/RcppDeepState"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div> <p>In alternative it’s possible to directly download the source and install the package from a working R environment:</p> <div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">install.packages</span><span class="p">(</span><span class="s2">"/path/to/RcppDeepState"</span><span class="p">,</span><span class="w"> </span><span class="n">repos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">"source"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div> <h3 id="steps">Steps</h3> <p>In order to perform fuzz testing, RcppDeepState follows the same steps we have used in the previous posts, with a few more steps in between:</p> <ul> <li>find the exported Rcpp functions</li> <li>DeepState test harness creation</li> <li>package analysis using Valgrind</li> </ul> <p>Some steps are left out, such as the automatic test harness creation. We will see this later on in another post.</p> <h3 id="rcppdeepstate-auxiliary-functions">RcppDeepState auxiliary functions</h3> <p>The objective of RcppDeepState is to create a link between Rcpp and DeepState in order to perform fuzz testing. This can be done by using some C++ auxiliary function that initializes all the necessary symbolic variables. Symbolic variables were already discussed in a previous article <sup id="fnref:3"><a href="#fn:3" class="footnote" rel="footnote" role="doc-noteref">3</a></sup>.</p> <p>A list of common auxiliary functions is reported in the following list:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">RcppDeepState_int()</code>: generates an integer symbolic variable. Optionally, the parameters <code class="language-plaintext highlighter-rouge">int low, int high</code> can be used to restrict the generated numbers in a range</li> <li> <code class="language-plaintext highlighter-rouge">RcppDeepState_double()</code>: generates a double symbolic variable. Optionally, the parameters <code class="language-plaintext highlighter-rouge">double low, double high</code> can be used to restrict the generated numbers in a range</li> <li> <code class="language-plaintext highlighter-rouge">RcppDeepState_IntegerVector</code>: generates a vector of integers with a size in the range 0-100 (inclusive). Optionally, the parameters <code class="language-plaintext highlighter-rouge">int size, int low, int high</code> can be used to specify the vector size and to restrict the generated numbers in a range.</li> <li> <code class="language-plaintext highlighter-rouge">RcppDeepState_NumericVector()</code>: generates a vector of doubles with a size in the range 0-100 (inclusive). Optionally, the parameters <code class="language-plaintext highlighter-rouge">int size, int low, int high</code> can be used to specify the vector size and to restrict the generated numbers in a range.</li> <li> <code class="language-plaintext highlighter-rouge">RcppDeepState_NumericMatrix()</code>: generates a matrix of doubles with a size in the range (rows=0,cols=0) and (10,10). Optionally, the parameters <code class="language-plaintext highlighter-rouge">int row,int column,int low,int high</code> can be used to specify the matrix size (in terms of rows and cols) and to restrict the generated numbers in a range.</li> <li> <code class="language-plaintext highlighter-rouge">RcppDeepState_CharacterVector()</code>: generates a vector of characters with a size in the range 0-100 (inclusive).</li> <li> <code class="language-plaintext highlighter-rouge">RcppDeepState_string()</code>: generates a string of a length up to 26 characters taken from the alphabet.</li> </ul> <p>This functions can be used in the test harness <code class="language-plaintext highlighter-rouge">TEST</code> procedure. Let’s use an example to further understand this.</p> <h3 id="rcppdeepstate-testharness-sample">RcppDeepState TestHarness sample</h3> <p>RcppDeepState has an automated test harness generation function, <code class="language-plaintext highlighter-rouge">deepstate_harness_create()</code>. However, we manually create a TestHarness using the auxiliary functions indicated above in order to understand how RcppDeepState works behind the scenes.</p> <p>Assume you have a leaked function that takes an integer as an input and allocates some Heap memory to it. Consider the case where the developer failed to free the used memory if the integer parameter is more than <code class="language-plaintext highlighter-rouge">500</code>. Imagine that for some strange motivation the developer forgot to free the used memory if the integer parameter is greater than <code class="language-plaintext highlighter-rouge">500</code> for some strange reason. The following is an example of the function:</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">copyAndFreeVector</span><span class="p">(</span><span class="kt">int</span> <span class="n">source</span><span class="p">){</span>
    <span class="c1">// allocates some space for 1 integer</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">sample</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">){</span>
        <span class="n">free</span><span class="p">(</span><span class="n">sample</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>A TestHarness can be generated for this program, using the auxiliary functions above. It can be simply done by creating a symbolic integer variable, initialized using the appropriate <code class="language-plaintext highlighter-rouge">RcppDeepState_int(int low, int high)</code> function. As you can see, in order to work with Rcpp and RcppDeepState you need to include the necessary libraries.</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;deepstate/DeepState.hpp&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Rcpp.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;RcppDeepState.h&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">deepstate</span><span class="p">;</span>

<span class="c1">// [[Rcpp::export]]</span>
<span class="kt">void</span> <span class="nf">copyAndFreeVector</span><span class="p">(</span><span class="kt">int</span> <span class="n">source</span><span class="p">){</span>
    <span class="c1">// allocates some space for 1 integer</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">sample</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">){</span>
        <span class="n">free</span><span class="p">(</span><span class="n">sample</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">IntAllocation</span><span class="p">,</span> <span class="n">AllocateIntegerWithoutFree</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">RcppDeepState_int</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="n">copyAndFreeVector</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now that the test harness is completed we can compile it, and run the fuzz testing with Valgrind. The compilation needs a lot of library and headers inclusion in order to properly work. We need to include the headers files for R, Rcpp, RcppDeepState and RcppArmadillo. In addition we need to specify to <code class="language-plaintext highlighter-rouge">g++</code> where to find the shared objects (.so files) for R and RInside. The <code class="language-plaintext highlighter-rouge">-g</code> option is included to add more debugging information to the compiled binary, which is worth mentioning.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>g++ <span class="nt">-I</span>/usr/include/R 
    <span class="nt">-I</span>/usr/lib/R/library/Rcpp/include 
    <span class="nt">-I</span>/usr/lib/R/library/RcppDeepState/include 
    <span class="nt">-I</span>/usr/lib/R/library/RcppArmadillo/include  
    <span class="nt">-L</span>/usr/lib64/R/lib 
    <span class="nt">-L</span>/usr/lib/R/library/RInside/lib 
    <span class="nt">-lR</span> <span class="nt">-lRInside</span> <span class="nt">-ldeepstate</span> <span class="nt">-o</span> program <span class="nt">-g</span> program.cpp
</code></pre></div></div> <p>The last step is to run the compiled program using Valgrind with the <code class="language-plaintext highlighter-rouge">--leak-check=full</code> option in order to find memory leaks.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>valgrind <span class="nt">--leak-check</span><span class="o">=</span>full ./program <span class="nt">--fuzz</span> <span class="nt">--timeout</span><span class="o">=</span>1
</code></pre></div></div> <p>This is the result</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">==29579== Memcheck, a memory error detector</span>
<span class="s">==29579== Copyright (C) 2002-2022, and GNU GPL'd, by Julian Seward et al.</span>
<span class="s">==29579== Using Valgrind-3.19.0 and LibVEX; rerun with -h for copyright info</span>
<span class="na">==29579== Command</span><span class="pi">:</span> <span class="s">./program --fuzz --timeout=1</span>
<span class="s">==29579==</span> 
<span class="na">INFO</span><span class="pi">:</span> <span class="s">Starting fuzzing</span>
<span class="na">WARNING</span><span class="pi">:</span> <span class="s">No seed provided; using </span><span class="m">1653991738</span>
<span class="na">WARNING</span><span class="pi">:</span> <span class="s">No test specified, defaulting to first test defined (IntAllocation_AllocateIntegerWithoutFree)</span>
<span class="na">INFO</span><span class="pi">:</span> <span class="s">Done fuzzing! Ran 11711 tests (11711 tests/second) with 0 failed/11711 passed/0 abandoned tests</span>
<span class="s">==29579==</span> 
<span class="na">==29579== HEAP SUMMARY</span><span class="pi">:</span>
<span class="na">==29579==     in use at exit</span><span class="pi">:</span> <span class="s">23,544 bytes in 5,885 blocks</span>
<span class="na">==29579==   total heap usage</span><span class="pi">:</span> <span class="s">11,735 allocs, 5,850 frees, 165,956 bytes allocated</span>
<span class="s">==29579==</span> 
<span class="s">==29579== 23,536 bytes in 5,884 blocks are definitely lost in loss record 2 of </span><span class="m">2</span>
<span class="na">==29579==    at 0x4845888</span><span class="pi">:</span> <span class="s">malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)</span>
<span class="na">==29579==    by 0x11B414</span><span class="pi">:</span> <span class="s">copyAndFreeVector(int) (program.cpp:10)</span>
<span class="na">==29579==    by 0x11B484</span><span class="pi">:</span> <span class="s">DeepState_Test_IntAllocation_AllocateIntegerWithoutFree() (program.cpp:18)</span>
<span class="na">==29579==    by 0x11B439</span><span class="pi">:</span> <span class="s">DeepState_Run_IntAllocation_AllocateIntegerWithoutFree() (program.cpp:16)</span>
<span class="na">==29579==    by 0x113130</span><span class="pi">:</span> <span class="s">DeepState_RunTestNoFork (in /home/fabri/test/testHarness/RcppTestHarness/program)</span>
<span class="na">==29579==    by 0x113654</span><span class="pi">:</span> <span class="s">DeepState_FuzzOneTestCase (in /home/fabri/test/testHarness/RcppTestHarness/program)</span>
<span class="na">==29579==    by 0x1138E7</span><span class="pi">:</span> <span class="s">DeepState_Fuzz (in /home/fabri/test/testHarness/RcppTestHarness/program)</span>
<span class="na">==29579==    by 0x10EDAA</span><span class="pi">:</span> <span class="s">main (in /home/fabri/test/testHarness/RcppTestHarness/program)</span>
<span class="s">==29579==</span> 
<span class="na">==29579== LEAK SUMMARY</span><span class="pi">:</span>
<span class="na">==29579==    definitely lost</span><span class="pi">:</span> <span class="s">23,536 bytes in 5,884 blocks</span>
<span class="na">==29579==    indirectly lost</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="na">==29579==      possibly lost</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="na">==29579==    still reachable</span><span class="pi">:</span> <span class="s">8 bytes in 1 blocks</span>
<span class="na">==29579==         suppressed</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="s">==29579== Reachable blocks (those to which a pointer was found) are not shown.</span>
<span class="s">==29579== To see them, rerun with</span><span class="err">:</span> <span class="s">--leak-check=full --show-leak-kinds=all</span>
<span class="s">==29579==</span> 
<span class="s">==29579== For lists of detected and suppressed errors, rerun with</span><span class="err">:</span> <span class="s">-s</span>
<span class="na">==29579== ERROR SUMMARY: 1 errors from 1 contexts (suppressed</span><span class="pi">:</span> <span class="s">0 from 0)</span>
</code></pre></div></div> <p>As you can see, the program allocates 11,735 integers, but frees only 5,850 of them. Valgrind tells us that the error is due to the <code class="language-plaintext highlighter-rouge">malloc</code> call in the program at line 10:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">==29579==    at 0x4845888</span><span class="pi">:</span> <span class="s">malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)</span>
<span class="na">==29579==    by 0x11B414</span><span class="pi">:</span> <span class="s">copyAndFreeVector(int) (program.cpp:10)</span>
</code></pre></div></div> <p>Let’s solve the problem and run fuzz testing again.</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;deepstate/DeepState.hpp&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Rcpp.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"RcppDeepState.h"</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">deepstate</span><span class="p">;</span>

<span class="c1">// [[Rcpp::export]]</span>
<span class="kt">void</span> <span class="nf">copyAndFreeVector</span><span class="p">(</span><span class="kt">int</span> <span class="n">source</span><span class="p">){</span>
    <span class="c1">// allocates some space for 1 integer</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">sample</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="n">free</span><span class="p">(</span><span class="n">sample</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">IntAllocation</span><span class="p">,</span> <span class="n">AllocateIntegerWithoutFree</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">RcppDeepState_int</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="n">copyAndFreeVector</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>With the exception of the 8 bytes classified as <code class="language-plaintext highlighter-rouge">stil reachable</code>, we don’t have any memory leaks this time. I discovered that these 8 bytes are related to the inclusion of the R library (<code class="language-plaintext highlighter-rouge">-lR</code> argument).</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">==29423== Memcheck, a memory error detector</span>
<span class="s">==29423== Copyright (C) 2002-2022, and GNU GPL'd, by Julian Seward et al.</span>
<span class="s">==29423== Using Valgrind-3.19.0 and LibVEX; rerun with -h for copyright info</span>
<span class="na">==29423== Command</span><span class="pi">:</span> <span class="s">./program --fuzz --timeout=1</span>
<span class="s">==29423==</span> 
<span class="na">INFO</span><span class="pi">:</span> <span class="s">Starting fuzzing</span>
<span class="na">WARNING</span><span class="pi">:</span> <span class="s">No seed provided; using </span><span class="m">1653991674</span>
<span class="na">WARNING</span><span class="pi">:</span> <span class="s">No test specified, defaulting to first test defined (IntAllocation_AllocateIntegerWithoutFree)</span>
<span class="na">INFO</span><span class="pi">:</span> <span class="s">Done fuzzing! Ran 6335 tests (6335 tests/second) with 0 failed/6335 passed/0 abandoned tests</span>
<span class="s">==29423==</span> 
<span class="na">==29423== HEAP SUMMARY</span><span class="pi">:</span>
<span class="na">==29423==     in use at exit</span><span class="pi">:</span> <span class="s">8 bytes in 1 blocks</span>
<span class="na">==29423==   total heap usage</span><span class="pi">:</span> <span class="s">6,359 allocs, 6,358 frees, 144,452 bytes allocated</span>
<span class="s">==29423==</span> 
<span class="na">==29423== LEAK SUMMARY</span><span class="pi">:</span>
<span class="na">==29423==    definitely lost</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="na">==29423==    indirectly lost</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="na">==29423==      possibly lost</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="na">==29423==    still reachable</span><span class="pi">:</span> <span class="s">8 bytes in 1 blocks</span>
<span class="na">==29423==         suppressed</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="s">==29423== Reachable blocks (those to which a pointer was found) are not shown.</span>
<span class="s">==29423== To see them, rerun with</span><span class="err">:</span> <span class="s">--leak-check=full --show-leak-kinds=all</span>
<span class="s">==29423==</span> 
<span class="s">==29423== For lists of detected and suppressed errors, rerun with</span><span class="err">:</span> <span class="s">-s</span>
<span class="na">==29423== ERROR SUMMARY: 0 errors from 0 contexts (suppressed</span><span class="pi">:</span> <span class="s">0 from 0)</span>
</code></pre></div></div> <h2 id="conclusion">Conclusion</h2> <p>In this post we have seen how to use RcppDeepState auxiliary functions to manually generate a Test Harness. This is a procedure that is always done in an automated way by using <code class="language-plaintext highlighter-rouge">deepstate_harness_create()</code>. The purpose of this post is to understand how the Test Harness creation procedure works and combine RcppDeepState with a simple Rcpp program.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1"> <p><a href="https://cran.r-project.org/web/packages/Rcpp/index.html" rel="external nofollow noopener" target="_blank">Rcpp package on CRAN</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:2"> <p><a href="https://akhikolla.github.io/" rel="external nofollow noopener" target="_blank">Akhila Chowdary blog</a> <a href="#fnref:2" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:3"> <p><a href="https://fabriziosandri.github.io/gsoc-2022-blog/deepstate/2022/05/25/about-deepstate.html#symbols-definition">DeepState symbols definition</a> <a href="#fnref:3" class="reversefootnote" role="doc-backlink">↩</a></p> </li> </ol> </div> </div> </article> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2025 Fabrizio Sandri. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-0HTGSMCLSW"></script> <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'G-0HTGSMCLSW');
  </script> <script defer src="/assets/js/google-analytics-setup.js?12374742c4b1801ba82226e617af7e2d"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>