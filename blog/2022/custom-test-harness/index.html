<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="adA2euCk5kykbeBzBFe7a-qGnkIiaI7x3jJgqrfEEIo"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Write a custom test harness for functions with unsupported datatypes | Fabrizio Sandri </title> <meta name="author" content="Fabrizio Sandri"> <meta name="description" content="Guide to write a custom test harness for a function that cannot be analyzed because of some datatypes falling outside of the supported ones."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico?77b41fb878aeb1e52dc168c0807c497e"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://fabriziosandri.github.io/blog/2022/custom-test-harness/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Fabrizio</span> Sandri </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Write a custom test harness for functions with unsupported datatypes</h1> <p class="post-meta"> Created on July 29, 2022 </p> <p class="post-tags"> <a href="/blog/2022"> <i class="fa-solid fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/google-summer-of-code"> <i class="fa-solid fa-hashtag fa-sm"></i> Google Summer of Code</a>   <a href="/blog/tag/rcppdeepstate"> <i class="fa-solid fa-hashtag fa-sm"></i> RcppDeepState</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="introduction">Introduction</h2> <p>The list of supported datatypes maintained by RcppDeepState is used to automatically create test harnesses for functions whose supported datatypes fall within this list. This list was created using a frequency table of the top 100 Rcpp types found in CRAN packages<sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>. The complete list of supported datatypes is provided below:</p> <ul> <li><code class="language-plaintext highlighter-rouge">int</code></li> <li><code class="language-plaintext highlighter-rouge">double</code></li> <li><code class="language-plaintext highlighter-rouge">string</code></li> <li><code class="language-plaintext highlighter-rouge">Rcpp::NumericVector</code></li> <li><code class="language-plaintext highlighter-rouge">Rcpp::IntegerVector</code></li> <li><code class="language-plaintext highlighter-rouge">Rcpp::NumericMatrix</code></li> <li><code class="language-plaintext highlighter-rouge">Rcpp::CharacterVector</code></li> <li><code class="language-plaintext highlighter-rouge">arma::mat</code></li> </ul> <p>It is possible for a function you want to analyze to have a parameter that is not on this list, in which case RcppDeepState will notify you that the function cannot be examined due to an unsupported parameter.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>We can't test the function - unsupported_datatype - due to the following datatypes falling out of the allowed ones: LogicalVector

Failed to create testharness for 1 functions in the package - unsupported_datatype
</code></pre></div></div> <p>This just indicates that the automatic procedure to create a test harness cannot be used, not that your function cannot be analyzed at all. The test harness must therefore be manually created together with its directory structure, and it must then be examined. I’ll explain this procedure in this blog article.</p> <h2 id="the-procedure">The procedure</h2> <p>RcppDeepState involves two steps:</p> <ul> <li> <em>generator</em>: automatically generates the harness and all the inputs</li> <li> <em>runner</em>: analyze the package running each function given the inputs of the generator step</li> </ul> <p>The generator step cannot be used for a function whose inputs are not supported, so we must manually run the steps to construct the directory structure for this function. This can be done using the existing RcppDeepState functions.</p> <p>Given the path of the package being analyzed <code class="language-plaintext highlighter-rouge">package_location</code> and the name of the function which datatypes fall out of the supported ones <code class="language-plaintext highlighter-rouge">function_name</code>, the <code class="language-plaintext highlighter-rouge">deepstate_create_makefile</code> function can be used to generate the directory structure for the custom test harness:</p> <div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">deepstate_create_makefile</span><span class="p">(</span><span class="n">package_location</span><span class="p">,</span><span class="w"> </span><span class="n">function_name</span><span class="p">)</span><span class="w">
</span></code></pre></div></div> <p>If everything goes smoothly, you can begin creating the custom test harness for your function. The test harness file must be named <code class="language-plaintext highlighter-rouge">function_name_DeepState_TestHarness.cpp</code>, where <code class="language-plaintext highlighter-rouge">function_name</code>is the name of the function you want to analyze. You can use the following template as a reference.</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;RInside.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;RcppDeepState.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;qs.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;DeepState.hpp&gt;</span><span class="cp">
</span>
<span class="n">RInside</span> <span class="n">Rinstance</span><span class="p">;</span>

<span class="cm">/** FUNCTION SIGNATURE
* signature of the function being analyzed must be added here 
*/</span>

<span class="cm">/** INPUTS
* here you can define all the inputs for your function, and initialize them
* with a random value generator. Define your inputs inside the `#define INPUTS` 
* macro.
* 
* Example: initialize a random integer parameter 'arg1':
* #define INPUTS \
*   int arg1 = DeepState_Int();
*/</span>

<span class="n">TEST</span><span class="p">(</span><span class="o">&lt;</span><span class="n">package_name</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">generator</span><span class="p">){</span>
  <span class="n">INPUTS</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="o">&lt;</span><span class="n">package_name</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">runner</span><span class="p">){</span>
  <span class="n">INPUTS</span>

  <span class="cm">/** INPUTS DUMP
  * for each input defined above you have to save it in the 'inputs' directory
  * created before using the function qs::c_qsave(param, "./inputs/arg_name.qs", 
  * "high", "zstd", 1, 15, true, 1). Remember to replace 'arg_name' inside 
  * "./inputs/arg_name.qs" with the name of the associated input argument.
  * 
  * Example: save the 'arg1' input defined before:
  * qs::c_qsave(arg1, "./inputs/arg1.qs", "high", "zstd", 1, 15, true, 1)
  */</span>

  <span class="k">try</span><span class="p">{</span>
    <span class="cm">/** FUNCTION INVOCATION
    * here you have to add the invocation of the function being analyzed with 
    * all its parameters defined in the section PARAMETERS.
    */</span> 
  <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="n">Rcpp</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">"Exception Handled"</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Remember to replace <code class="language-plaintext highlighter-rouge">&lt;package_name&gt;</code> in the <code class="language-plaintext highlighter-rouge">TEST(&lt;package_name&gt;, generator)</code> definition with your package name (without angular brackets).</p> <p>Once the harness has been created you can generate the inputs and analyze the function containing unsupported datatypes as arguments.</p> <div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">deepstate_fuzz_fun</span><span class="p">(</span><span class="n">package_location</span><span class="p">,</span><span class="w"> </span><span class="n">function_name</span><span class="p">)</span><span class="w">
</span><span class="n">result</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">deepstate_harness_analyze_pkg</span><span class="p">(</span><span class="n">package_location</span><span class="p">)</span><span class="w">
</span></code></pre></div></div> <h2 id="example">Example</h2> <p>I want to provide an example of the <code class="language-plaintext highlighter-rouge">unsupported_datatype</code> function that can be found in the testSAN package<sup id="fnref:2"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>. This function uses a <code class="language-plaintext highlighter-rouge">LogicalVector</code> as its single parameter, thus RcppDeepState will skip this function from the analysis.</p> <p>To solve this I followed all the steps mentioned above. First of all I ran the <code class="language-plaintext highlighter-rouge">deepstate_create_makefile</code> function, remembering that I had to define the missing variables(<code class="language-plaintext highlighter-rouge">package_location</code> and <code class="language-plaintext highlighter-rouge">function_name</code>):</p> <div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">package_location</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"/home/fabri/test/testHarness/RcppDeepState/inst/testpkgs/testSAN"</span><span class="w">
</span><span class="n">function_name</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"unsupported_datatype"</span><span class="w">

</span><span class="n">deepstate_create_makefile</span><span class="p">(</span><span class="n">package_location</span><span class="p">,</span><span class="w"> </span><span class="n">function_name</span><span class="p">)</span><span class="w">
</span></code></pre></div></div> <p>At the end of this, a directory containing the following content has been created:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unsupported_datatype
├── inputs
├── Makefile
└── unsupported_datatype_output
</code></pre></div></div> <p>Then I moved on and created the test harness file inside the <code class="language-plaintext highlighter-rouge">unsupported_datatype</code> directory and I renamed this file as <code class="language-plaintext highlighter-rouge">unsupported_datatype_DeepState_TestHarness.cpp</code>. I followed the template provided above. This is the result:</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;RInside.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;RcppDeepState.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;qs.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;DeepState.hpp&gt;</span><span class="cp">
</span>
<span class="n">RInside</span> <span class="n">Rinstance</span><span class="p">;</span>

<span class="cm">/** FUNCTION SIGNATURE */</span>
<span class="kt">int</span> <span class="nf">unsupported_datatype</span><span class="p">(</span><span class="n">Rcpp</span><span class="o">::</span><span class="n">LogicalVector</span> <span class="n">param</span><span class="p">);</span>

<span class="cm">/** INPUTS */</span> 
<span class="cp">#define INPUTS \
  LogicalVector param = RcppDeepState_LogicalVector();
</span>
<span class="n">Rcpp</span><span class="o">::</span><span class="n">LogicalVector</span> <span class="nf">RcppDeepState_LogicalVector</span><span class="p">(){</span>
  <span class="kt">int</span> <span class="n">rand_size</span> <span class="o">=</span> <span class="n">DeepState_IntInRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">);</span>
  <span class="n">Rcpp</span><span class="o">::</span><span class="n">LogicalVector</span> <span class="n">rand_vec</span><span class="p">(</span><span class="n">rand_size</span><span class="p">);</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rand_size</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>      
    <span class="n">rand_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeepState_IntInRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>  
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">rand_vec</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">testSAN</span><span class="p">,</span> <span class="n">generator</span><span class="p">){</span>
  <span class="n">INPUTS</span>  
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">testSAN</span><span class="p">,</span> <span class="n">runner</span><span class="p">){</span>
  <span class="n">INPUTS</span>

  <span class="cm">/** INPUTS DUMP */</span>
  <span class="n">qs</span><span class="o">::</span><span class="n">c_qsave</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="s">"./inputs/param.qs"</span><span class="p">,</span> <span class="s">"high"</span><span class="p">,</span> <span class="s">"zstd"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

  <span class="k">try</span><span class="p">{</span>
    <span class="cm">/** FUNCTION INVOCATION */</span>
    <span class="n">unsupported_datatype</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
  <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="n">Rcpp</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">"Exception Handled"</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>You can notice that I have created an auxiliary function <code class="language-plaintext highlighter-rouge">RcppDeepState_LogicalVector</code> used to generate a random <code class="language-plaintext highlighter-rouge">LogicalVector</code> of size ranging from 1 to 20 elements.</p> <p>Finally I run the last two steps:</p> <div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">deepstate_fuzz_fun</span><span class="p">(</span><span class="n">package_location</span><span class="p">,</span><span class="w"> </span><span class="n">function_name</span><span class="p">)</span><span class="w">
</span><span class="n">result</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">deepstate_harness_analyze_pkg</span><span class="p">(</span><span class="n">package_location</span><span class="p">)</span><span class="w">
</span></code></pre></div></div> <p>If you print the <code class="language-plaintext highlighter-rouge">result</code> table you will find that <code class="language-plaintext highlighter-rouge">unsupported_datatype</code> has finally been tested with RcppDeepState.</p> <hr> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1"> <p><a href="https://github.com/FabrizioSandri/RcppDeepState/issues/10#issuecomment-1179190239" rel="external nofollow noopener" target="_blank">Top 100 Rcpp types found in CRAN packages</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:2"> <p><a href="https://github.com/FabrizioSandri/RcppDeepState/blob/master/inst/testpkgs/testSAN/src/unsupported_datatype.cpp" rel="external nofollow noopener" target="_blank">unsupported_datatype function</a> <a href="#fnref:2" class="reversefootnote" role="doc-backlink">↩</a></p> </li> </ol> </div> </div> </article> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2025 Fabrizio Sandri. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-0HTGSMCLSW"></script> <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'G-0HTGSMCLSW');
  </script> <script defer src="/assets/js/google-analytics-setup.js?12374742c4b1801ba82226e617af7e2d"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>