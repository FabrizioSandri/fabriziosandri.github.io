<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="adA2euCk5kykbeBzBFe7a-qGnkIiaI7x3jJgqrfEEIo"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Debugging Rcpp outside of R | Fabrizio Sandri </title> <meta name="author" content="Fabrizio Sandri"> <meta name="description" content="A detailed description of debugging Rcpp functions outside of the R environment using Valgrind"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico?77b41fb878aeb1e52dc168c0807c497e"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://fabriziosandri.github.io/blog/2022/rcpp-debugging/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Fabrizio</span> Sandri </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Debugging Rcpp outside of R</h1> <p class="post-meta"> Created on June 10, 2022 </p> <p class="post-tags"> <a href="/blog/2022"> <i class="fa-solid fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/google-summer-of-code"> <i class="fa-solid fa-hashtag fa-sm"></i> Google Summer of Code</a>   <a href="/blog/tag/rcpp"> <i class="fa-solid fa-hashtag fa-sm"></i> Rcpp</a>   <a href="/blog/tag/valgrind"> <i class="fa-solid fa-hashtag fa-sm"></i> Valgrind</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="introduction">Introduction</h1> <p>Sometimes it could be necessary to test your Rcpp defined code using an external tool, like Valgrind or GDB. This process however will almost likely come to a crash of your program with a strange Segmentation Fault error. The error is due to the fact that executing Rcpp code is only possible within a working R environment. I talked about this with a Rcpp community member and his answer is reported in this issue <a href="https://github.com/RcppCore/Rcpp/issues/1221" rel="external nofollow noopener" target="_blank">#1221</a>.</p> <blockquote> <p>“All” that <code class="language-plaintext highlighter-rouge">Rcpp</code> does is to provide <code class="language-plaintext highlighter-rouge">R</code> with callable code via the <code class="language-plaintext highlighter-rouge">.Call()</code> interface which is meant to <em>extend a running R session</em>. Nowhere in the <code class="language-plaintext highlighter-rouge">R</code> (or <code class="language-plaintext highlighter-rouge">Rcpp</code>) documentation is it hinted that you can run code separately. Which is why we run all tests etc from <code class="language-plaintext highlighter-rouge">R</code>.</p> </blockquote> <p>So, the question might appear straightforward, but is it feasible to run Rcpp code outside of a R environment? Using RInside, the answer is yes.</p> <h2 id="proof-of-concept">Proof of concept</h2> <p>Imagine you have the following <code class="language-plaintext highlighter-rouge">bootstrap</code> function and want to simply execute it and get the result, that you expect to be <code class="language-plaintext highlighter-rouge">10</code>.</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Rcpp.h&gt;</span><span class="cp">
</span>
<span class="c1">// [[Rcpp::export]]</span>
<span class="kt">int</span> <span class="nf">bootstrap</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Allocate a sample NumericVector</span>
    <span class="n">Rcpp</span><span class="o">::</span><span class="n">NumericVector</span> <span class="n">sample</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">50</span><span class="p">};</span>
    
    <span class="k">return</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">bootstrap</span><span class="p">()</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>If you try to compile and execute this program however the result is quite different:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>g++ <span class="nt">-lR</span> <span class="nt">-I</span><span class="s2">"/usr/include/R/"</span> <span class="nt">-I</span>/usr/local/include  <span class="nt">-I</span><span class="s2">"/home/fabri/R/x86_64-pc-linux-gnu-library/4.2/Rcpp/include"</span> <span class="nt">-L</span>/usr/lib64/R/lib <span class="nt">-o</span> bootstrap bootstrap.cpp
<span class="nv">$ </span> ./bootstrap
<span class="o">[</span>1]    23848 segmentation fault <span class="o">(</span>core dumped<span class="o">)</span>  ./bootstrap
</code></pre></div></div> <h3 id="solution">Solution</h3> <p>The solution is to embed in your code a working R environment within the process. This can be done using the powerful RInside library. All you have to do is to include the header files and create an embedded R instance. The preceding example will be modified as follows:</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Rcpp.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;RInside.h&gt;</span><span class="cp">
</span>
<span class="c1">// [[Rcpp::export]]</span>
<span class="kt">int</span> <span class="nf">bootstrap</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">RInside</span> <span class="n">R</span><span class="p">;</span>
    <span class="c1">// Allocate a sample NumericVector</span>
    <span class="n">Rcpp</span><span class="o">::</span><span class="n">NumericVector</span> <span class="n">sample</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">50</span><span class="p">};</span>
    
    <span class="k">return</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">bootstrap</span><span class="p">()</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>There will be no errors if you try to compile and run the program after this update.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>g++ <span class="nt">-g</span> <span class="nt">-lR</span> <span class="nt">-lRInside</span> <span class="nt">-I</span><span class="s2">"/usr/include/R/"</span> <span class="nt">-I</span>/usr/local/include <span class="nt">-I</span>/usr/lib/R/library/RInside/include <span class="nt">-I</span><span class="s2">"/home/fabri/R/x86_64-pc-linux-gnu-library/4.2/Rcpp/include"</span> <span class="nt">-L</span>/usr/lib/R/library/RInside/lib <span class="nt">-Wl</span>,-rpath<span class="o">=</span>/usr/lib/R/library/RInside/lib <span class="nt">-L</span>/usr/lib64/R/lib <span class="nt">-o</span> bootstrap bootstrap.cpp
<span class="nv">$ </span> ./bootstrap
10
</code></pre></div></div> <h2 id="debugging-with-deepstate-and-valgrind">Debugging with Deepstate and valgrind</h2> <p>Now that we have all of the necessary tools, we can start developing our first Rcpp function test harness. Imagine that we want to fuzz test a function named <code class="language-plaintext highlighter-rouge">getFirstElement</code> that returns the first element of an Rcpp IntegerVector. Deepstate might be used to send some randomly initialized vectors to this method in order to discover any memory issues. To do this, we may create a basic test harness that employs a function that produces a random integer vector, in this instance <code class="language-plaintext highlighter-rouge">randomIntegerVector</code>, and then passes that vector to the <code class="language-plaintext highlighter-rouge">getFirstElement</code> function. This is the final result.</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Rcpp.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;RInside.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;deepstate/DeepState.hpp&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">deepstate</span><span class="p">;</span>

<span class="c1">// [[Rcpp::export]]</span>
<span class="kt">int</span> <span class="nf">getFirstElement</span><span class="p">(</span><span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// random IntegerVector generation procedure</span>
<span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="nf">randomIntegerVector</span><span class="p">(</span><span class="kt">int</span> <span class="n">maxSize</span><span class="p">){</span>

    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">DeepState_IntInRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">maxSize</span><span class="p">);</span>
    <span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="n">vec</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeepState_IntInRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span>
  
    <span class="k">return</span> <span class="n">vec</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">TEST</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="n">name</span><span class="p">){</span>
    <span class="k">static</span> <span class="n">RInside</span> <span class="n">R</span><span class="p">;</span>
    
    <span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="n">randomVec</span> <span class="o">=</span> <span class="n">randomIntegerVector</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

    <span class="n">getFirstElement</span><span class="p">(</span><span class="n">randomVec</span><span class="p">);</span>

<span class="p">}</span>
</code></pre></div></div> <p>It’s worth noting that the RInside instance has been defined as static, this will prevent error such as <code class="language-plaintext highlighter-rouge">R is already initialized</code>. Making the <code class="language-plaintext highlighter-rouge">R</code> variable static force the application to use the same RInside object for all of the application’s lifetime.</p> <p>Let’s now compile the harness and run it with the Valgrind Memcheck tool</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>g++ <span class="nt">-g</span> <span class="nt">-ldeepstate</span> <span class="nt">-lR</span> <span class="nt">-lRInside</span> <span class="nt">-I</span><span class="s2">"/usr/include/R/"</span> <span class="nt">-I</span>/usr/local/include <span class="nt">-I</span>/usr/lib/R/library/RInside/include <span class="nt">-I</span><span class="s2">"/home/fabri/R/x86_64-pc-linux-gnu-library/4.2/Rcpp/include"</span> <span class="nt">-L</span>/usr/lib/R/library/RInside/lib <span class="nt">-Wl</span>,-rpath<span class="o">=</span>/usr/lib/R/library/RInside/lib <span class="nt">-L</span>/usr/lib64/R/lib <span class="nt">-o</span> getFirstElement getFirstElement.cpp
<span class="nv">$ </span>valgrind  ./getFirstElement <span class="nt">--fuzz</span> <span class="nt">--timeout</span><span class="o">=</span>10
</code></pre></div></div> <p>This will be the result</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">==43210== Memcheck, a memory error detector</span>
<span class="s">==43210== Copyright (C) 2002-2022, and GNU GPL'd, by Julian Seward et al.</span>
<span class="s">==43210== Using Valgrind-3.19.0 and LibVEX; rerun with -h for copyright info</span>
<span class="na">==43210== Command</span><span class="pi">:</span> <span class="s">./getFirstElement --fuzz --timeout=10</span>
<span class="s">==43210==</span> 
<span class="na">INFO</span><span class="pi">:</span> <span class="s">Starting fuzzing</span>
<span class="na">WARNING</span><span class="pi">:</span> <span class="s">No seed provided; using </span><span class="m">1654880923</span>
<span class="na">WARNING</span><span class="pi">:</span> <span class="s">No test specified, defaulting to first test defined (Unit_name)</span>
<span class="na">INFO</span><span class="pi">:</span> <span class="s">Done fuzzing! Ran 1828 tests (182 tests/second) with 0 failed/1828 passed/0 abandoned tests</span>
<span class="s">==43210==</span> 
<span class="na">==43210== HEAP SUMMARY</span><span class="pi">:</span>
<span class="na">==43210==     in use at exit</span><span class="pi">:</span> <span class="s">51,299,862 bytes in 9,936 blocks</span>
<span class="na">==43210==   total heap usage</span><span class="pi">:</span> <span class="s">30,813 allocs, 20,877 frees, 87,993,209 bytes allocated</span>
<span class="s">==43210==</span> 
<span class="na">==43210== LEAK SUMMARY</span><span class="pi">:</span>
<span class="na">==43210==    definitely lost</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="na">==43210==    indirectly lost</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="na">==43210==      possibly lost</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="na">==43210==    still reachable</span><span class="pi">:</span> <span class="s">51,299,862 bytes in 9,936 blocks</span>
<span class="na">==43210==                       of which reachable via heuristic</span><span class="pi">:</span>
<span class="na">==43210==                         newarray           </span><span class="pi">:</span> <span class="s">4,264 bytes in 1 blocks</span>
<span class="na">==43210==         suppressed</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="s">==43210== Rerun with --leak-check=full to see details of leaked memory</span>
<span class="s">==43210==</span> 
<span class="s">==43210== For lists of detected and suppressed errors, rerun with</span><span class="err">:</span> <span class="s">-s</span>
<span class="na">==43210== ERROR SUMMARY: 0 errors from 0 contexts (suppressed</span><span class="pi">:</span> <span class="s">0 from 0)</span>
</code></pre></div></div> <h1 id="conclusion">Conclusion</h1> <p>We were able to run a debugging tool, specifically the Valgrind suite’s Memcheck tool. This demonstrates how integrating many techniques may be an effective method of solving a problem.</p> </div> </article> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2025 Fabrizio Sandri. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-0HTGSMCLSW"></script> <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'G-0HTGSMCLSW');
  </script> <script defer src="/assets/js/google-analytics-setup.js?12374742c4b1801ba82226e617af7e2d"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>