<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="adA2euCk5kykbeBzBFe7a-qGnkIiaI7x3jJgqrfEEIo"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Rcpp package fuzz testing with RcppDeepState | Fabrizio Sandri </title> <meta name="author" content="Fabrizio Sandri"> <meta name="description" content="An quick overview of package fuzz testing using RcppDeepState"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico?77b41fb878aeb1e52dc168c0807c497e"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://fabriziosandri.github.io/blog/2022/rcppdeepstate-automatic-fuzz-testing-copy/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Fabrizio</span> Sandri </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Rcpp package fuzz testing with RcppDeepState</h1> <p class="post-meta"> Created on June 07, 2022 </p> <p class="post-tags"> <a href="/blog/2022"> <i class="fa-solid fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/google-summer-of-code"> <i class="fa-solid fa-hashtag fa-sm"></i> Google Summer of Code</a>   <a href="/blog/tag/rcppdeepstate"> <i class="fa-solid fa-hashtag fa-sm"></i> RcppDeepState</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="automated-fuzz-testing">Automated fuzz testing</h1> <p>We saw how to manually create a Test Harness for a Rcpp written function in order to run fuzz testing on it in the previous blog article. In practice, this strategy is never used: the majority of the time, the Harness construction process is automated. This is what we’ll talk about in this blog article.</p> <h2 id="the-steps">The steps</h2> <p>The RcppDeepState library was introduced in the previous post to do package fuzz testing. This library includes a collection of features that allow you to construct the test harness for a certain package function automatically.</p> <p>RccpDeepState includes the following two key functions:</p> <ul> <li><code class="language-plaintext highlighter-rouge">deepstate_harness_compile_run</code></li> <li><code class="language-plaintext highlighter-rouge">deepstate_harness_analyze_pkg</code></li> </ul> <p>Let’s take a closer look at them.</p> <h3 id="the-compilation-procedure">The compilation procedure</h3> <p>The function <code class="language-plaintext highlighter-rouge">deepstate_harness_compile_run(package_path)</code> is used to run the compilation process, and it accepts the location of the library we want to fuzz test.</p> <p>This step begins by looking for any Rcpp written functions in the supplied library. This is accomplished by looking for information about the package’s exported functions, which are found in the <code class="language-plaintext highlighter-rouge">RcppExports.cpp</code> file in the <code class="language-plaintext highlighter-rouge">src</code> source folder. Once you’ve gathered all of the data, you’ll need to construct a test harness file. This phase is done by <code class="language-plaintext highlighter-rouge">deepstate_pkg_create</code>, which generates a Harness file for each function discovered in <code class="language-plaintext highlighter-rouge">&lt;package_dir&gt;/inst/testfiles/&lt;function_name&gt;</code>. This file includes the headers as well as the ‘TEST’ function definition, which includes all of the symbolic variables.</p> <p>Using the <code class="language-plaintext highlighter-rouge">R CMD INSTALL</code> command, a shared object for the library is also produced (<code class="language-plaintext highlighter-rouge">.so</code> file). It’s worth noting that the shared object must be compiled with the <code class="language-plaintext highlighter-rouge">-g</code> option in order to include debug symbols. I discovered that the shared object was produced without debugging symbols on some Linux systems. I wrote an additional piece of code to rewrite the <code class="language-plaintext highlighter-rouge">Makevars</code> file holding the compilation parameters in order to solve the problem. This issue is solved in the <a href="https://github.com/FabrizioSandri/RcppDeepState/pull/3" rel="external nofollow noopener" target="_blank">Pull request #3</a>.</p> <p>The fuzz testing approach begins once the library and harness have been generated: the output of the tests is stored in order to evaluate them later using Valgrind.</p> <h3 id="the-analysis-phase">The analysis phase</h3> <p>Following the completion of the fuzz testing, the next step is to analyze the inputs generated. This is done using <code class="language-plaintext highlighter-rouge">deepstate_harness_analyze_pkg(package_path)</code>. This function looks for binary files containing the inputs in the <code class="language-plaintext highlighter-rouge">&lt;package_dir&gt;/inst/testfiles</code> directory. The harness is then rerun with the <code class="language-plaintext highlighter-rouge">--input_test_file</code> option: this allows to provide an input test case. It’s worth noting that in this second stage, the harness is examined by the Valgrind Memcheck tool, resulting in an XML log file.</p> <p>RcppDeepState then parses this file for error information (message, line number, etc.) and returns them to the <code class="language-plaintext highlighter-rouge">deepstate_harness_analyze_pkg(package_path)</code> function.</p> <h2 id="example">Example</h2> <p>RcppDeepState includes a sample library under the <code class="language-plaintext highlighter-rouge">RcppDeepState/inst/testpkgs/testSAN</code> folder. It can be useful as a toy library for detecting problems. Following the approach outlined in the previous part, we examine the package in this section.</p> <p>The first step is to use <code class="language-plaintext highlighter-rouge">deepstate_harness_compile_run</code> to compile the library. This function prints a list of successfully constructed harness when the compilation processes are done. In this example, all of the functions were appropriately built. On the other hand, if any functions are not built, an error message is generated.</p> <div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">deepstate_harness_compile_run</span><span class="p">(</span><span class="s2">"RcppDeepState/inst/testpkgs/testSAN"</span><span class="p">)</span><span class="w">

</span><span class="n">...</span><span class="w"> </span><span class="n">compilation</span><span class="w"> </span><span class="n">steps</span><span class="w"> </span><span class="n">...</span><span class="w">

</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="s2">"rcpp_read_out_of_bound"</span><span class="w">      </span><span class="s2">"rcpp_use_after_deallocate"</span><span class="w">  
</span><span class="p">[</span><span class="m">3</span><span class="p">]</span><span class="w"> </span><span class="s2">"rcpp_use_after_free"</span><span class="w">         </span><span class="s2">"rcpp_use_uninitialized"</span><span class="w">     
</span><span class="p">[</span><span class="m">5</span><span class="p">]</span><span class="w"> </span><span class="s2">"rcpp_write_index_outofbound"</span><span class="w"> </span><span class="s2">"rcpp_zero_sized_array"</span><span class="w">  
</span></code></pre></div></div> <p>The next step is to use Valgrind’s Memcheck tool to perform the analysis.</p> <div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">deepstate_harness_analyze_pkg</span><span class="p">(</span><span class="s2">"RcppDeepState/inst/testpkgs/testSAN"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div> <p>We may get a detailed description of the faults detected by printing the contents of <code class="language-plaintext highlighter-rouge">result$logtable</code> :</p> <div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">knitr</span><span class="o">::</span><span class="n">kable</span><span class="p">(</span><span class="n">result</span><span class="o">$</span><span class="n">logtable</span><span class="p">)</span><span class="w">
</span><span class="o">|</span><span class="n">err.kind</span><span class="w">    </span><span class="o">|</span><span class="n">message</span><span class="w">                </span><span class="o">|</span><span class="n">file.line</span><span class="w">                    </span><span class="o">|</span><span class="n">address.msg</span><span class="w">                                                 </span><span class="o">|</span><span class="n">address.trace</span><span class="w">                </span><span class="o">|</span><span class="w">
</span><span class="o">|:-----------|:----------------------|:----------------------------|:-----------------------------------------------------------|:----------------------------|</span><span class="w">
</span><span class="o">|</span><span class="n">InvalidRead</span><span class="w"> </span><span class="o">|</span><span class="n">Invalid</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">|</span><span class="n">use_after_deallocate.cpp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="o">|</span><span class="n">Address</span><span class="w"> </span><span class="mh">0x806cfe5</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">free</span><span class="s1">'d |use_after_deallocate.cpp : 6 |
|InvalidRead |Invalid read of size 1 |use_after_deallocate.cpp : 7 |Address 0x806cfe5 is 5 bytes after a block of size 0 free'</span><span class="n">d</span><span class="w"> </span><span class="o">|</span><span class="n">use_after_deallocate.cpp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="o">|</span><span class="w">

</span><span class="o">|</span><span class="n">err.kind</span><span class="w">    </span><span class="o">|</span><span class="n">message</span><span class="w">                </span><span class="o">|</span><span class="n">file.line</span><span class="w">                    </span><span class="o">|</span><span class="n">address.msg</span><span class="w">                                                 </span><span class="o">|</span><span class="n">address.trace</span><span class="w">                </span><span class="o">|</span><span class="w">
</span><span class="o">|:-----------|:----------------------|:----------------------------|:-----------------------------------------------------------|:----------------------------|</span><span class="w">
</span><span class="o">|</span><span class="n">InvalidRead</span><span class="w"> </span><span class="o">|</span><span class="n">Invalid</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">|</span><span class="n">use_after_deallocate.cpp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="o">|</span><span class="n">Address</span><span class="w"> </span><span class="mh">0x806cfe5</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">free</span><span class="s1">'d |use_after_deallocate.cpp : 6 |
|InvalidRead |Invalid read of size 1 |use_after_deallocate.cpp : 7 |Address 0x806cfe5 is 5 bytes after a block of size 0 free'</span><span class="n">d</span><span class="w"> </span><span class="o">|</span><span class="n">use_after_deallocate.cpp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="o">|</span><span class="w">

</span><span class="o">|</span><span class="n">err.kind</span><span class="w">    </span><span class="o">|</span><span class="n">message</span><span class="w">                </span><span class="o">|</span><span class="n">file.line</span><span class="w">                    </span><span class="o">|</span><span class="n">address.msg</span><span class="w">                                                 </span><span class="o">|</span><span class="n">address.trace</span><span class="w">                </span><span class="o">|</span><span class="w">
</span><span class="o">|:-----------|:----------------------|:----------------------------|:-----------------------------------------------------------|:----------------------------|</span><span class="w">
</span><span class="o">|</span><span class="n">InvalidRead</span><span class="w"> </span><span class="o">|</span><span class="n">Invalid</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">|</span><span class="n">use_after_deallocate.cpp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="o">|</span><span class="n">Address</span><span class="w"> </span><span class="mh">0x806cfe5</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">free</span><span class="s1">'d |use_after_deallocate.cpp : 6 |
|InvalidRead |Invalid read of size 1 |use_after_deallocate.cpp : 7 |Address 0x806cfe5 is 5 bytes after a block of size 0 free'</span><span class="n">d</span><span class="w"> </span><span class="o">|</span><span class="n">use_after_deallocate.cpp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="o">|</span><span class="w">


</span></code></pre></div></div> </div> </article> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2025 Fabrizio Sandri. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-0HTGSMCLSW"></script> <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'G-0HTGSMCLSW');
  </script> <script defer src="/assets/js/google-analytics-setup.js?12374742c4b1801ba82226e617af7e2d"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>